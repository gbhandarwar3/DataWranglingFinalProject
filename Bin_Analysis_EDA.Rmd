---
title: "Bin Testing & EDA"
author: "Ryan Pontius"
date: "2025-11-15"
output: html_document
---

--
Overview: This script runs statistical testing on the Youtube Shorts TikTok Tends 2025 dataset and generates several plots. 2-sample z-scores for proportion are ran across completion rate bins to identify statistically significant differences between neighboring bins. These results are then visualized and exported as a csv.

Input (1): youtube_shorts_tiktok_trends_2025_labeled.csv

Outputs (4): i) 2 lollipop plots: base_lolipop.png, significant_lolipop.png
         ii) 1 lineplot: completion_rate_lineplot.png
         iii) 1 csv file of: z_test_bin_results.csv

To Run Script: Modify path to csv file manually, or set your working directory manually then run R markdown script as normal.
--


-
The following libraries are called to run this script.
-
```{r}
library(DataExplorer)
library(dplyr)
library(ggplot2)
library(stringr)
library(scales)
library(ggcorrplot)
```


-
Purpose: Initialize the cleaned, main dataframe as "dfMain" using the input youtube_shorts_tiktok_trends_2025_labeled.csv. 
Input: youtube_shorts_tiktok_trends_2025_labeled.csv (csv file)
Output: dfMain (variable)
-
```{r}

#setwd()
dfMain <- read.csv("~/Desktop/Data_Wrangling/Final/Data/youtube_shorts_tiktok_trends_2025_labeled.csv")
dim(dfRaw) #48079 rows, 59 cols

introduce(dfMain) #Confirm no missing data columns/values
# convert viral from binary to categorical & assign to new column viral_char
dfMain$viral_char <- factor(dfMain$viral, levels = c(0,1), labels = c("Not Viral", "Viral"))

```


-
Purpose: Assign bins to each completion rate into 0.01-wide intervals and calcualte proportion viral for each bin size. Visualize distribution of proportion of videos viral (y-axis) by completion rate bin (x-axis) as a lollipop plot.
Input: dfMain (variable)
Output: base_lolipop.png (file png)
-
```{r}

dfMain <- dfMain %>% # Initialize new column "comp_bin". Assign bins (size 0.01) to the "completion_rate" column to group them by completion legnth.
  mutate(comp_bin = cut(completion_rate, breaks = seq(0, 1, by = 0.01), include.lowest = TRUE))

# Group data frame by comp_bin and calculate the proportion viral for each bin.
# ChatGPT helped me calculate the viral_prop bins.
viral_prop_by_bin <- dfMain %>%
  group_by(comp_bin) %>%
  summarize(
    total = n(),
    viral_count = sum(viral_char == "Viral"),
    viral_prop = viral_count / total) %>%
  filter(!is.na(comp_bin)) # Drop rows with empty comp_bin value.

#ChatGPT wrote the label_fun funciton.
label_fun <- function(x) { # This function changes the formatting of the x-axis labels by dropping "[ )" and replacing the comma "," with a dash "-".
  x <- gsub("\\(|\\]|\\[|\\]", "", x)
  x <- sub(",", "-", x)
  x
}
#Plot the lollipop plot.
# x-axis = completion rate bins, y-axis = proportion of videos in bin that went viral.
lolli<- ggplot(viral_prop_by_bin, aes(x = comp_bin, y = viral_prop)) +
  geom_segment(aes(x = comp_bin, xend = comp_bin, y = 0, yend = viral_prop), color = "skyblue", size = 1.5) +
  geom_point(color = "skyblue", size = 3) +
  scale_x_discrete(labels = label_fun) +
  labs(title = "Proportion of Viral Videos by Completion Rate",
       x = "Completion Rate (Bin size = 0.01)",
       y = "Proportion Viral") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1.1, vjust = 1.5,size = 6.2),
        axis.text.y = element_text(size = 8, vjust = 0.1, hjust = -0.3),
        axis.title.y = element_text(size = 12, vjust=3.5),
        axis.title.x = element_text(size = 12),
        plot.title = element_text(hjust = 0.5, vjust = 0.1,size = 18),
        plot.margin = margin(t = 15, r = 25, b = 20, l = 25))

ggsave("base_lolipop.png",lolli, width = 7, height = 4)


```


-
Purpose: Test whether neighboring bins differ in proportion viral by statsitically testing these differences using a 2-sample z-test for difference in proportions via a loop.
Input: dfMain (variable)
Output: z_test_bin_results.csv (file csv)

-

```{r}
# Chat GPT wrote this entire loop for me.
min_count <- 30  # Min sample size needed for each bin to calculate z-statistic.
results <- data.frame(bin1 = character(), bin2 = character(), #Initialize output container for z-test results as the loop runs.
                      total_bin1 = numeric(), total_bin2 = numeric(),
                      z = numeric(), p_value = numeric(), stringsAsFactors=FALSE)

# Main loop for calculating each 2-sample z-score for proportions.
for(i in 1:(nrow(viral_prop_by_bin) - 1)){
  n1 <- viral_prop_by_bin$total[i]
  n2 <- viral_prop_by_bin$total[i+1]

  if(n1 >= min_count & n2 >= min_count){#Check if each bin meets sample size parameter to proceed.
    x1 <- viral_prop_by_bin$viral_count[i]
    x2 <- viral_prop_by_bin$viral_count[i+1]
    p1 <- x1 / n1
    p2 <- x2 / n2
    p_pool <- (x1 + x2) / (n1 + n2)
    se <- sqrt(p_pool * (1 - p_pool) * (1/n1 + 1/n2))
    if(se == 0){ # Protective feature to prevent division by 0.
      z <- NA
      p_val <- NA
    } else {
      z <- (p1 - p2) / se
      p_val <- 2 * (1 - pnorm(abs(z)))
    }
    # Add 2-samp z test results to output variable.
    results <- rbind(results, data.frame(
      bin1 = viral_prop_by_bin$comp_bin[i],
      bin2 = viral_prop_by_bin$comp_bin[i+1],
      total_bin1 = n1,
      total_bin2 = n2,
      z = z,
      p_value = p_val
    ))
  } else {
    # Handels missing data (if initial condition is not met)
    results <- rbind(results, data.frame(
      bin1 = viral_prop_by_bin$comp_bin[i],
      bin2 = viral_prop_by_bin$comp_bin[i+1],
      total_bin1 = n1,
      total_bin2 = n2,
      z = NA,
      p_value = NA
    ))
  }
}


# Create a "significance" column to indicate if p-value is significant in output.
results <- results %>%
  mutate(significant = case_when(
    p_value < 0.05 ~ "TRUE",
    TRUE ~ ""
  )) %>%
  mutate(p_value = signif(p_value, 3),
         z = signif(z, 3))

write.csv(results, "z_test_bin_results.csv", row.names = FALSE)


```

-
Purpose: Regenerates the same lollipop plot from earlier, except this time significant bin gaps are highlighted in red. A brute force approach is taken to assign statistically significant bins.
Input: dfMain (variable)
Output: significant_lolipop.png (file png)
-

```{r}

highlight_bins <- c("(0.44,0.45]", "(0.45,0.46]", "(0.52,0.53]", "(0.53,0.54]", "(0.72,0.73]", "(0.73,0.74]", "(0.74,0.75]")  # Significant bins that need to be highlighted red.
viral_prop_by_bin$significant_bin <- ifelse(viral_prop_by_bin$comp_bin %in% highlight_bins, "Significant", "Not Significant") #Add column "significant_bin" and populate to indicate significant results.

#lollipop plotting for significant bins.
sig_lolli <- ggplot(viral_prop_by_bin, aes(x = comp_bin, y = viral_prop, color = significant_bin)) +
  geom_segment(aes(x = comp_bin, xend = comp_bin, y = 0, yend = viral_prop), size = 1.5) +
  geom_point(size = 3) +
  scale_color_manual(values = c("Not Significant" = "skyblue", "Significant" = "red")) + # Color code lolipops
  scale_x_discrete(labels = label_fun) +# Clean up the x-axis lables using the label_fun function from earlier.
  labs(title = "Proportion of Viral Videos by Completion Rate",
       x = "Completion Rate (Bin size = 0.01)",
       y = "Proportion Viral",
       color = "Significant Difference:") +
  theme_minimal() + # Specify plot theme
  # Modify features like text size, legend position, and plot margins.
  theme(axis.text.x = element_text(angle = 45, hjust = 1.1, vjust = 1.5,size = 6.2),
        axis.text.y = element_text(size = 8, vjust = 0.1, hjust = -0.3),
        axis.title.y = element_text(size = 12, vjust=3.5),
        axis.title.x = element_text(size = 12),
        legend.position = "top",
        legend.text = element_text(size = 9),
        legend.title = element_text(size = 9),
        plot.title = element_text(hjust = 0.5, vjust = 0.1,size = 18),
        plot.margin = margin(t = 15, r = 25, b = 20, l = 25))
sig_lolli
ggsave("significant_lolipop.png",sig_lolli, width = 7, height = 4) # Save output
```

-
Purpose: Visualize average completion rate of videos split into viral and non viral groups via a line plot.
input: dfMain (variable)
output: completion_rate_lineplot.png (file csv)
-

```{r}
# Initialize variable lineplot that will be used to export lineplot to png.
lineplot <- dfMain %>%
  group_by(category, viral_char) %>%
  summarize(mean_completion = mean(completion_rate)) %>% # Calulate mean completion rate & initialize column mean_completion to save it in.
  ggplot(aes(x = category, y = mean_completion, color = viral_char, group = viral_char)) + # Color by virality
    geom_line(size = 1) +
    geom_point(size = 2) +
    scale_color_manual(values = c("Not Viral" = "grey", "Viral" = "hotpink")) + # Change variable names.
    labs(# Assign titles.
      title = "Mean Completion Rate Across Video Genres",
      x = "Video Genre",
      y = "Mean Completion Rate",
      color = "Virality:"
    ) +
    theme_minimal() + #Specify plot theme
    # Modify features like text size, legend position, and plot margins.
    theme(axis.text.x = element_text(angle = 45, hjust = 1.1, vjust = 1.1,size = 8.2),
        axis.text.y = element_text(size = 8, vjust = 0.1, hjust = -0.3),
        axis.title.y = element_text(size = 12, vjust=3.5),
        axis.title.x = element_text(size = 12),
        legend.position = "top",
        legend.text = element_text(size = 9),
        legend.title = element_text(size = 9),
        plot.title = element_text(hjust = 0.5, vjust = 0.1,size = 18),
        plot.margin = margin(t = 15, r = 25, b = 20, l = 25))
lineplot
ggsave("completion_rate_lineplot.png", width = 7, height = 4) # Save output


```
